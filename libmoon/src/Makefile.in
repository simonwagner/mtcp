
.PHONY: clean

### TARGET ###
PS=@PSIO@
DPDK=@DPDK@
NETMAP=@NETMAP@
LRO=@LRO@
MOONMTCPMTCP_LIB_DIR=../lib
MOONMTCPMTCP_LIB=libmoonmtcp.a
MTCP_HDR_DIR=../../mtcp/include
MTCP_HDR = mtcp_api.h mtcp_epoll.h


### GCC ###
GCC=@CC@

### FLAGS ###
GCC_OPT = -m64 -Wall -fPIC -fgnu89-inline
#DBG_OPT = -DDBGMSG -DDBGFUNC -DSTREAM -DSTATE -DTSTAT -DAPP -DEPOLL
#DBG_OPT = -DDBGMSG -DDBGFUNC -DSTREAM -DSTATE
#DBG_OPT += -DPKTDUMP
#DBG_OPT += -DDUMP_STREAM
#GCC_OPT += -g -DNETSTAT -DINFO -DDBGERR -DDBGCERR
GCC_OPT += -DNDEBUG -O3 -DNETSTAT -DINFO -DDBGERR -DDBGCERR
#GCC_OPT += -DNDEBUG -g -DNETSTAT -DINFO -DDBGERR -DDBGCERR
GCC_OPT += $(DBG_OPT)

ifeq ($(LRO),1)
GCC_OPT += -DENABLELRO
endif


### LIBRARIES AND INCLUDES ###
INC_DIR=../include
INC= -iquote$(INC_DIR)

# DPDK LIBRARY and HEADER
DPDK_INC=@DPDKLIBPATH@/include
DPDK_LIB=@DPDKLIBPATH@/lib/
# CFLAGS for DPDK-related compilation
ifeq ($(DPDK), 1)
DPDK_MACHINE_FLAGS = $(shell cat @DPDKLIBPATH@/include/cflags.txt)
INC += ${DPDK_MACHINE_FLAGS} -I${DPDK_INC} -include $(DPDK_INC)/rte_config.h
else
INC += -DDISABLE_DPDK
endif

ifeq ($(wildcard /usr/lib/libhugetlbfs.so),) 
else
	GCC_OPT += -DHUGEPAGE
endif

# mtcp includes
INC+=-iquote../../mtcp/src/include

# io_engine includes, required by some of the mtcp headers
INC+=-iquote../../io_engine/include

### SOURCE CODE ###
SRCS = moon_mtcp.c

OBJS = $(patsubst %.c,%.o,$(SRCS))
DEPS = $(patsubst %.c,.%.d,$(SRCS))


### GOALS ###
all: default

default: $(OBJS)
	mkdir -p $(MOONMTCPMTCP_LIB_DIR)
	ar rvs $(MOONMTCPMTCP_LIB_DIR)/$(MOONMTCPMTCP_LIB) $(OBJS)

$(OBJS): %.o: %.c Makefile
	$(GCC) $(GCC_OPT) $(INC) -c $< -o $@
$(DEPS): .%.d: %.c Makefile
	$(GCC) $(GCC_OPT) $(INC) -MM $(CFLAGS) $< > $@

-include $(DEPS)

clean: clean-library
	rm -f *.o *~ core
	rm -f .*.d

clean-library:
	rm -f $(MOONMTCPMTCP_LIB_DIR)/*

distclean: clean
	rm -f Makefile
